
<!DOCTYPE HTML>
<html lang="en-GB">
<head>
	<meta charset="utf-8">
	<title>A blog about faith, tech and management.  | John Dreams</title>

	<meta name="author" content="John Storey">

<meta name="description" content="It&rsquo;s been a long time since I&rsquo;ve posted. Why? Because my job takes up 100% of my time, and my girlfriend another 30%. Life has gone back &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="John Dreams" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">John Dreams</a></h1>
<span class="tagline">A blog about faith, tech and management.</span>
<nav id="main-nav"><ul>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archives</a></li>
	<li><a href="/contact">Contact</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/about">About</a></li>
	<li><a href="/archives">Archives</a></li>
	<li><a href="/contact">Contact</a></li>
</ul>
</div>
	</div>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/09/27/trying-polyphasic-sleeping/">
			
				Trying Polyphasic Sleeping</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-09-27T20:10:00-07:00" pubdate data-updated="true">Sep 27<sup>th</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		<p>It&rsquo;s been a long time since I&rsquo;ve posted. Why? Because my job takes up 100% of my time, and my girlfriend another 30%. Life has gone back to extreme craziness.</p>

<p>Finally I was speaking to a client about <em>The Four Hour Body</em>, which I have yet to read. He spoke about polyphasic sleeping, which rang a bell in my head from years ago &hellip;</p>

<p>People are functional on 2 hours sleep? Say what? It&rsquo;s true. That&rsquo;s called the &ldquo;Uberman&rdquo; in the polyphasic world, and it&rsquo;s the most hard core you can get. All you do is nap every 4 hours. No other sleep.</p>

<p>Ouch.</p>

<p>But for 7+ years the IT staffer <a href="http://www.puredoxyk.com/index.php/polyphasic-sleep-portal/">puredoxyk</a>  has lived the &ldquo;Everyman 3&rdquo; schedule. In this plan you sleep three hours a night and have 3 daily naps of 20 minutes, for a total of 4 hours of sleep in 24. Better, it is a schedule that allows you to interact with the rest of humanity. Now I have people I talk to daily 12 and 13 timezones away. So I&rsquo;m often talking to them in the middle of the night, then with clients the next day. If there was only a way to be functional while doing that I could really smooth things out in many projects. Plus I could blog more, work on the novel plot, learn Clojure, review Calculus (I&rsquo;m ashamed to say I&rsquo;ve forgotten most of it), and more &hellip;</p>

<p>I&rsquo;m truly insane. It&rsquo;s day 3 now. My body is starting to adapt &mdash; or so I think. I didn&rsquo;t really maintain a great sleep schedule before, so it&rsquo;s hard to say. But yesterday I started actually sleeping during the 20 minute naps. I believe I am dreaming, but as before, I don&rsquo;t seem to remember 99% of my dreams. Today I woke from my 20 minute nap relaxed and refreshed. That should be a sign that REM sleep has been experienced.</p>

<p>Also, in the last 3 days, I&rsquo;ve accomplished more than I usually do in a week.</p>

<p>We&rsquo;ll see how well this lasts. It is supposed to take a month to really get your body used to it. The extra time is super useful in today&rsquo;s world though. I feel like back in the 90s when I did Atkins. Everyone thought it would kill me somehow. Instead there was a decrease in my waist from 48&#8221; to 33&#8221;. Could polyphasic sleeping be a repeat?</p>

<p>Stay tuned. See if I last!</p>

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/05/04/investments-on-sale-again/">
			
				Investments on Sale - Again!</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-05-04T12:13:00-07:00" pubdate data-updated="true">May 4<sup>th</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		<p>Lately I&rsquo;ve been turning my eye back to my investments, primarily in equities. Well, really, since doing my takes and updating the retirement plan.</p>

<p>I&rsquo;m here to say: the news is good for the bargain hunter.</p>

<p>Marc Faber popped up in the Wall Street Journal today with a viewpoint that I believe: the U.S. market can see another 20% decline.</p>

<p>Helping dollar destruction, Bernanke seems poised to do QE3, even if it may be under another name.</p>

<p>Europe is the U.S. 2009 (oh, did I make money in oil futures that year? I did!). Spain is undoubtedly being combed by bargain hunters, but there is likely enough for everyone. With companies that have nice exposure to emerging markets in Latin America.</p>

<p>France is likely to elect Holland to run the place. Can we say an end to austerity in the Euro zone, cheap money everywhere, and more currency destruction.</p>

<p>Yes, I&rsquo;m really thinking alot about commodities again.</p>

<p>Other trends: we are a few years away from Social Security and Medicare running out in the U.S. That is a mega event beyond compare, and to be honest, I&rsquo;m not ready to take advantage of it. Time to make a plan.</p>

<p>There are some relevant factoids that should make any investor step back and reflect. There is lots going on here and values should pop up left and right, if only we can dig them out.</p>

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/04/19/wtf-apple/">
			
				WTF Apple ?!?</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-04-19T10:10:00-07:00" pubdate data-updated="true">Apr 19<sup>th</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		<p>Apple! My confused little company that brings beauty to computing. A little heart to heart. You, me, and the internet.</p>

<p>What misbegotten security theatre meme makes you suddenly want 3 &mdash; 3! &mdash; questions answered before you let me download more apps to my iPad 3? Why, of all the questions, are they so strange that I can only answer one? Why not let me choose the questions AND the answers? Why not let me opt out? Why is it so hard to buy things using you as a channel?</p>

<p>Let me calm down.</p>

<p>Look, more factors of authentication is not the answer. You quickly get past the point where the irritation is greater than the benefits. I will now go and fill in random answers to your random questions. You have wasted my time to the benefit of neither of us, and really irritated me.</p>

<p>Is this what you wanted?</p>

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/04/11/drupalizing-a-web-project/">
			
				Drupalizing a Web Project</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-04-11T08:45:00-07:00" pubdate data-updated="true">Apr 11<sup>th</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		<p>These are notes from <a href="http://dev.nodeone.se/en/drupalizing-a-web-project">http://dev.nodeone.se/en/drupalizing-a-web-project</a> for myself. Yes, a blog post summarizing a blog post. Just think of this as a page in my notebook. Without the dead trees.</p>

<ol>
<li>Understand the problem domain, likely issues, and needed functionality.</li>
<li>Map out content types and entities.</li>
<li> Access control.</li>
<li> Reuse across site?</li>
<li> Inter-relationships?</li>
<li>User groups and their properties.</li>
<li> Roles.</li>
<li> Profiles.</li>
<li> Etc.</li>
<li>Consider views into the data.</li>
<li>Consider business rules that can be put in Rules module.</li>
<li>Look at what this process might have missed.</li>
<li>Non-IA</li>
<li> Performance and scalability.</li>
<li> Localization and internationalization.</li>
<li> Data migration.</li>
<li> Integration</li>
<li> Etc.</li>
</ol>


		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/02/14/adventures-in-drupal-services-endpoints/">
			
				Adventures in Drupal Services Endpoints</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-02-14T10:06:00-08:00" pubdate data-updated="true">Feb 14<sup>th</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		<p>Adventures with Drupal Services</p>

<p>If you are writing a web services interface on top of Drupal 7, you might be tempted to do something like use menu callbacks. The menu system in Drupal really is just a bunch of code that is called and spits back HTML for you. It&rsquo;s common to write your own menu code that takes and spits back whatever you want. Now that I think of it, this is probably how the Drupal Services module is written way down. There is certainly no immediately obvious reason not to do it that way.</p>

<p>These are some notes I found while getting a simple services module written. They, like my current knowledge, are incomplete. In many areas I have yet to fathom why they are like this. My concern is limited to the use of the REST Server in the Services 3 code.</p>

<h1>More than CRUD.</h1>

<p>All this section comes from reading the code in services/servers/rest_server/includes/RESTServer.inc., particularly the method <strong>resolveController()</strong>. This method is the source of the most common error when writing your own services &mdash; <strong>Cannot find controller</strong>. It is worth your time to read the code and get a sense of how it works.</p>

<p>Services has CRUD hardwired into it. It assumes the following CRUD methods:</p>

<ul>
<li>retrieve</li>
<li>create</li>
<li>update</li>
<li>delete</li>
</ul>


<p>Now this is clearly not enough to make a pretty, full featured REST API. So Services 3 allows you to add in two other types of API endpoints.</p>

<h2>Actions.</h2>

<p>According to the README for the REST server for services, actions</p>

<p><quote>
are performed directly on the resource type, not an individual resource.
</quote></p>

<p>An example is given of telling a search engine to reindex itself. This does not act on any particular piece of content, but rather works across all the content at one time.</p>

<p>For my purposes I wanted to use more descriptive names on my endpoints than, say, &lsquo;create&rsquo; so I only used actions. But I could have easily given an alias to the create endpoint in the code. In retrospect I should have gone that way but we&rsquo;ll look at code using actions for everything in this post.</p>

<h2>Targeted Actions.</h2>

<p>These are like actions, something that does not fit in the default CRUD API layout. The difference is that these work on an particular piece of content. For example, an endpoint might tell Drupal to append some content to an entity.</p>

<p>POST <a href="http://example.com/api/entity/123/append/run%20concluded">http://example.com/api/entity/123/append/run%20concluded</a></p>

<p>This hypothetical call would append the string &ldquo;run concluded&rdquo; to some field on the entity with etid 123.</p>

<p>I did not use targeted actions, so they won&rsquo;t be in the code in this post, but the idea is prett simple.</p>

<h2>Relations.</h2>

<p>Relations are a little different in that they retrieve content related to the content in question. For example, you might want an API to get a list of all files associated with a particular entity. You might want it to read like this</p>

<p>GET <a href="http://example.com/api/entity/243/filelist">http://example.com/api/entity/243/filelist</a></p>

<p>Pretty simple when you understand it. These terms are all used in the documentation, but how to create anything other than the basic CRUD endpoints in your custom code is not explained. We&rsquo;ll be showing you how to create custom actions (discerned from studying how the code works) here. Presumably relations are not all that different, but I will not swear to it.</p>

<h2>Why all the different types?</h2>

<p>I can only assume that there is some REST specification of which I am unaware. It seems fine to me to make them all &lsquo;actions&rsquo;, which is much like saying &lsquo;menu callbacks&rsquo;. The code for the REST server would be simplified, as would writing hooks for it. But Greg Dunlap has been doing Services for quite some time, and I have faith that he led a total rewrite of the framework for a reason. So for now I am concerning myself with what is, rather than why it is that way.</p>

<p>(brief pause as plane is landing and I need to shut off the laptop.)</p>

<h1>Some code &mdash; finally!</h1>

<p>At the end of the day, the best thing turns out to study the <strong>resolveController()</strong> method in <strong>RESTServer.inc</strong>, as explained above. Then look at the implementations of <strong>hook_services_resources()</strong> in the directory <strong>services/resources</strong>. They will show you how to declare actions.</p>

<p>With all this background, we can finally do the actual simple part: write the code.</p>

<h2>Hooks away!</h2>

<p>Some days I love Drupal&rsquo;s hook system. It makes coding so pleasurable. Other times I wonder about bootstrap costs. But that&rsquo;s another story.</p>

<p>First, let&rsquo;s declare a simple api with actions only and no CRUD. Here are some custom entry points for the &lsquo;drupalchat&rsquo; endpoint. Also notice that the &lsquo;messagecreate&rsquo; endpoint takes a &lsquo;struct&rsquo; type of parameter, which is populated by Services with payload data for a POST call. For the sake of simplicity we&rsquo;ll not comment on the standard access callback.</p>

<p><code>
/<em>*
 * Implements hook_services_resources().
 </em>/
function chat_rest_services_resources() {
  $resources[&lsquo;drupalchat&rsquo;] = array();
  $resources[&lsquo;drupalchat&rsquo;][&lsquo;actions&rsquo;] = array(</p>

<pre><code>'messagecreate' =&gt; array(
  'help' =&gt; 'Send a new chat message.',
  'callback' =&gt; '_chat_rest_send_msg',
  'access callback' =&gt; 'chat_rest_access',
  'access arguments' =&gt; array('create'),
  'access arguments append' =&gt; TRUE,
  'args' =&gt; array(
    array(
      'name' =&gt; 'data',
      'type' =&gt; 'struct',
      'description' =&gt; 'Recipient user id and message to send.',
      'source' =&gt; 'data',
      'optional' =&gt; FALSE,
    ),
  ),
),
'newmessages' =&gt; array(
  'help' =&gt; 'Get any new chat messages.',
  'callback' =&gt; '_chat_rest_retrieve',
  'access callback' =&gt; 'chat_rest_access',
  'access arguments' =&gt; array('new'),
  'access arguments append' =&gt; TRUE,
),
'updatebuddylist' =&gt; array(
  'help' =&gt; 'Get currently buddy list status.',
  'callback' =&gt; '_chat_rest_buddylist',
  'access callback' =&gt; 'chat_rest_access',
  'access arguments' =&gt; array('new'),
  'access arguments append' =&gt; TRUE,
),
</code></pre>

<p>  );</p>

<p>  return $resources;
}
</code></p>

<p>Lastly, define the endpoints to be shown in the Services configuration page.</p>

<p><code>
function chat_rest_default_services_endpoint() {
  $endpoint = new stdClass;
  $endpoint->disabled = FALSE; // endpoint disabled initially
  $endpoint->name = &lsquo;drupalchat&rsquo;;
  $endpoint->title = &lsquo;Drupalchat REST API&rsquo;;
  $endpoint->server = &lsquo;rest_server&rsquo;;
  $endpoint->path = &lsquo;js-api&rsquo;;
  $endpoint->authentication = array(</p>

<pre><code>'drupalchat' =&gt; array(
  'alias' =&gt; '',
  'actions' =&gt; array(
    'messagecreate' =&gt; array(
      'enabled' =&gt; 1,
    ),
    'newmessages' =&gt; array(
      'enabled' =&gt; 1,
    ),
    'updatebuddylist' =&gt; array(
      'enabled' =&gt; 1,
    ),
  ),
),
</code></pre>

<p>  );</p>

<p>  // TODO turn this debug to 0
  $endpoint->debug = 1;
  $endpoints[] = $endpoint;
  return $endpoints;
}
</code></p>

<p>That&rsquo;s it! Declaring a custom Services endpoint (or here, 3)  really is not that difficult once you understand how to do it.</p>

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/02/14/new-post/">
			
				New-post</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-02-14T10:05:00-08:00" pubdate data-updated="true">Feb 14<sup>th</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/01/07/deficencies-with-vagrant/">
			
				Deficencies With Vagrant</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-01-07T08:13:00-08:00" pubdate data-updated="true">Jan 7<sup>th</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		<p>I love the Vagrant project. Someday, hopefully soon, I&rsquo;ll be able to switch my whole developer organization over to using it. Here&rsquo;s a note to myself about what needs to happen first. I&rsquo;m posting so I can refer back from time to time and see if it&rsquo;s something we can use now (don&rsquo;t look at me, I&rsquo;m hacking on (Drupal)[<a href="http://drupal.org/">http://drupal.org/</a>]).</p>

<h1>Cannot Run in Bridged Mode</h1>

<p>You know what? For some reason in Virtual Box XDebug can only talk to a host  debugger if it&rsquo;s running in bridged networking mode. Unfortunately that is not a current Vagrant feature. I have seen a patch to network.rb that does not seem to work for me. Also I heard there is a patch in branch on Debian that was recently submitted.</p>

<p>On a personal level, if anyone can help me get XDebug working on OSX Lion and talking to MacGDP back on the host, I&rsquo;d greatly appreciate it. For my own work.</p>

<h1>Cannot Run on Windows Well</h1>

<p>This is a problem with gems that use native DLLs. Why do I care? <em>I</em> don&rsquo;t. Windows can disappear off the surface of hard drives across the planet for my money. But much of my company is full of developers who don&rsquo;t and don&rsquo;t desire to learn to work with anything other than Windows. I&rsquo;m just not going to move them anytime soon.</p>

<p>Unfortunately here is a current reality</p>

<ul>
<li>On Windows, Vagrant does not work on Ruby.</li>
<li>It does work on JRuby.</li>
<li>JRuby does not allow gems that use native API components.</li>
<li>Chef requires native API components.</li>
</ul>


<h1>When These Issues Resolve</h1>

<p>I&rsquo;ll be able to move the organization to Vagrant. Until then I&rsquo;ll get some of the value by distributing virtual machines and letting people share their source code folders into it.</p>

<p>It&rsquo;s annoying though. Vagrant is a great piece of software.</p>

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2012/01/01/mobile-drupal-cheap/">
			
				Mobile Drupal Made Easy</a>
		</h2>
		<div class="meta date">








  


<time datetime="2012-01-01T14:58:00-08:00" pubdate data-updated="true">Jan 1<sup>st</sup>, 2012</time></div>
	</header>
	<div class="entry-content">
		<p>January 1st, 2012. What a great year 2011 has been! A VP Engineering position where we turned the company around from self-immolation, and moving in with the girlfriend. No matter what else you can say, it&rsquo;s been exciting and one of the bigger growth experiences of my life. So how to top it in 2012? Hey, how to match it?</p>

<p>I have no idea. So instead I took my one week off at the end of the year (hey, turning that company around was a 7 day a week job!) to return to my favorite technology, Drupal. After some struggles with the Drupal 7 core code I can create entities and fields willy nilly. In real life it&rsquo;s almost always better to create them in the UI and export them with Features, but for really understanding what&rsquo;s happening you need to get as deep into the code as possible. So I did that, and used the knowledge to sketch out a new module idea with a friend. You should see the fruits of that around March. She&rsquo;s busy writing a book for Packt, and I have real life coming back in two days. That&rsquo;s going to slow us down.</p>

<p>Now, on to the topic of this post &hellip;</p>

<h1>Mobile Drupal Made Easy</h1>

<p>That company where they hired me in as VPE? After a year the first project has come along where Drupal seems the most appropriate answer (along with Apache Solr and possibly Node.js). We have the client kickoff the second week of January, then it&rsquo;s a pell mell rush for a three month delivery. Having had a months warning one of the first things we did was sketch out a preliminary architecture, then map out the areas where we had missing experience or an unclear idea how to proceed. One of those was in how to make mobile apps connected to Drupal in the most convienent way possible.</p>

<p>The short story was, for this client, make a standalone app makes little sense. Yes, we want to be in the app store, but we are going to use about zero percent of the native functionality. So despite a strong Sencha Touch skillset we want to try a new approach.</p>

<h1>Proposed: Responsive Web in a Phone Gap Wrapper</h1>

<p>We plan to create a responsive web design (we&rsquo;ve done some internal development tests with the Omega Theme to great success.) Then wrap it in PhoneGap or Sencha Touch wrapped in Phone Gap. That&rsquo;s the part we have not tried yet.</p>

<p>So I have a full day until real life work starts up. The emails already indicate the client pressure will be huge, and the new project starting up won&rsquo;t lessen anything. Let&rsquo;s see if you get a post showing PhoneGap wrapping XHTML and sized with a responsive web design. I have high hopes the approach will work fine because (a) it makes sense, and (b) it turns out there is a session on how to do the same thing being given at Drupalcon Denver in March.</p>

<p>Look for a post showing how to do this over the next few weeks.</p>

<p>Happy New Year!
John</p>

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2011/12/09/node-dot-js-and-mongodb-bof/">
			
				Node.js and mongoDB BOF</a>
		</h2>
		<div class="meta date">








  


<time datetime="2011-12-09T16:47:00-08:00" pubdate data-updated="true">Dec 9<sup>th</sup>, 2011</time></div>
	</header>
	<div class="entry-content">
		<p><em>These are unedited notes from the MongoSV 2011 Conference</em></p>

<p>mongoDB node.js driver has native and JS BSON libraries. Many forums recommend using the JS one. Moderator agrees. He may split the JS driver out to a completely separate repository and project.</p>

<p>Now it does cool things like getting the raw, unparsed BSON data. Good for HTML5 games for example, where the parsing is too slow.</p>

<p>Then native C++ driver is 2X slower serializing data, and 5X faster deserializer. Moderator blames it on his own limited C++ skills. In practice he does not see this as a limiting factor in most applications.</p>

<h1>GridFS</h1>

<p>Moderator experimenting with a feature like GridFS. Uses a collection of documents that have a chunk in them that is binary. Wants to make binary types in mongo much more efficent. Basically the moment it hits binary, like a video, it starts streaming it without much overhead.</p>

<h1>Mongoose</h1>

<p>If you want performance, don&rsquo;t use it. It&rsquo;s all about validating types; getters and setters; more expressive query builder; etc. It&rsquo;s alot slower.</p>

<p>In V8 try / catch and getter / setter are just not optimized. Also there are some crazy overloading of operator types.</p>

<h1>Safe Writes</h1>

<p>Off by default in JS and most mongoDB drivers. Considering making it on by default. Otherwise there is no way for you to know if your transactions work for example.</p>

<h1>SSL Support</h1>

<p>v2.2 they will add SSL support to the drivers. It&rsquo;s only waiting on US Export license approval.</p>

<h1>Multi CPU systems</h1>

<p>In Node.js you used to have to fire up a node process per CPU. Now it&rsquo;s in a configuration file.</p>

<h1>Advantage of V8</h1>

<p>Because you are on V8 you get to use the latest JS stuff all the time. object.create(), not this.prototype for example.</p>

<p>Buffer objects are created outside of V8 heap and stays until you release it. But is direct memory access speed. Increased JS driver speed by 5x.</p>

		
		
	</div>

</article>


    <article class="post">
	<header>
		<h2 class="title">
			
			<a href="/blog/2011/12/09/mopub-scaling/">
			
				MoPub Scaling</a>
		</h2>
		<div class="meta date">








  


<time datetime="2011-12-09T16:47:00-08:00" pubdate data-updated="true">Dec 9<sup>th</sup>, 2011</time></div>
	</header>
	<div class="entry-content">
		<p><em>These are unedited notes from the MongoSV 2011 Conference</em></p>

<p>50ms to process each event.</p>

<ul>
<li>Started as 3 founders hoping to bring Angry Birds on to the platform. Their customers are app developers.</li>
<li>Needed to scale quickly as customers came on</li>
<li>0 time to spend time on ops</li>
<li>chose Google App Engine</li>
<li>Python (?Guido? works on this team)</li>
</ul>


<p>Business objects are siloed per user account. One to many relationships.</p>

<p>Collect stats for every ad serve and ad interaction.</p>

<p>On app engine have a simple stats model.</p>

<h1>Realtime stats in GAE</h1>

<ul>
<li>datastore

<ul>
<li>expensive writes</li>
<li>slow writes 1 / sec/ entity group</li>
<li>fast reads 3 ms</li>
</ul>
</li>
<li>memcache</li>
<li>TaskQueues</li>
</ul>


<p>Cannot do sums over objects in GAE or even native map / reduces</p>

<p>Solution: Buffer into memcache then periodically flush to the datastore by pushing them into a TaskQueue.</p>

<h1>GAE Shortcomings</h1>

<ul>
<li>Transient downtime for writes</li>
<li>Read before write</li>
<li>memcache is fleeting, leading to data loss</li>
<li>Objects have become too large for transactions</li>
<li>writing to datastore, even buffered is expensive</li>
<li> pay for datastore CPU and app CPU. Way too costly.</li>
</ul>


<h1>AWS + Mongo</h1>

<ul>
<li>We have control of each service and the machines on which they run</li>
<li>access to RAM!</li>
<li>fire and forget increments</li>
<li>our entire machinery for recording mulitple stats is a series of increment instructions sent to MongoDB (which handles all buffering and flushing.)</li>
</ul>


<h1>First Attempt: Data Model</h1>

<p>One document per published advertiser per month. Each document stores data for all days and hours in the month.</p>

<h2>Initial results</h2>

<ul>
<li>Pros

<ul>
<li>Scales with # business objects</li>
<li>Queries for highel level cross products</li>
<li>Queries for stats for a given date range result in only reading the # of months total documents in the range</li>
</ul>
</li>
<li>Cons</li>
<li> Lots of little documents</li>
<li> more</li>
</ul>


<h1>Solution: New Data Model</h1>

<p>Account for ??? in our data model.</p>

<p>Everything in the account stored with hash table.</p>

<p>Created IndexDocument to store the reverse indices to do the higher-level cross sections</p>

<h2>Results</h2>

<ul>
<li>2 machines handle all the writes</li>
<li>Mongo load is now miniscule</li>
<li>each update really 2 (StatsDocument and StatsIndex)</li>
<li>Each get is really 2 gets (same objects)</li>
<li>One document per account per day</li>
<li> # documents scale with # accounts</li>
<li> we do the simple aggregation in python</li>
<li> size of document scales with # business objects within account</li>
<li> more</li>
</ul>


<h1>Lessons Learned</h1>

<ul>
<li>Better to have fewer, larger documents if there is a logical hierarchy than many smaller documents arranged flatly</li>
<li>Log everything because you will make mistakes</li>
<li> This has saved us time and again</li>
<li>Buy more memory</li>
<li> It&rsquo;s cheap!</li>
<li> Solved our cache misses</li>
<li> Some problems cannot be solved just by throwing memory at the problem</li>
</ul>


<h1>Future Work</h1>

<p>Mobile User store</p>

<ul>
<li>will record every interaction of every user</li>
<li>ML: map / reduce jobs to glean data about our suers and segment them</li>
<li>per user targeting with minimum latency</li>
<li>relevancy => better user experience => app devs make more money</li>
</ul>


		
		
	</div>

</article>


    <nav id="pagenavi">
        
            <a href="1" class="prev">Previous</a>
        
        
            <a href="3" class="next">Next</a>
        
    </nav>

</div>
	<footer id="footer" class="inner">&copy; 2014

    John Storey

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/hyphenator.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'blogjohnstoreyorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






</body>
</html>
