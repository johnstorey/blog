<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[John Dreams]]></title>
  <link href="http://blog.johnstorey.org/atom.xml" rel="self"/>
  <link href="http://blog.johnstorey.org/"/>
  <updated>2014-07-09T18:34:18-07:00</updated>
  <id>http://blog.johnstorey.org/</id>
  <author>
    <name><![CDATA[John Storey]]></name>
    
  </author>

  
  <entry>
    <title type="html"><![CDATA[Drupal Access Grants]]></title>
    <link href="http://blog.johnstorey.org/blog/2014/07/09/drupal-access-grants/"/>
    <updated>2014-07-09T15:25:19-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2014/07/09/drupal-access-grants</id>
    <content type="html"><![CDATA[<p>It&rsquo;s been quite a while since this blog has been posted too &mdash; or existed! Apparently the VPS hosting it was killed in a cleanup at some point in the past. I&rsquo;ve lost some posts. Oops!</p>

<p>But we are back, and today is a topic on one of my favorite topics &mdash; coding Drupal. In this case, Drupal 7.</p>

<h1>Access and Access Grants</h1>

<p>The last time I tried to customize the permission rules in Drupal was in Drupal 6, and grants were not an option. Instead there was the node access system, and various modules you could use to customize them. IIRC, I ended up using taxonomy access lite, which allowed me to customize access based on the tag on the content type. If any code denied access to a piece of content, even if 10 other modules said &lsquo;allow&rsquo;, the access was not granted. On top of that, the node access system seemed fairly fragile.</p>

<p>The experience sucked.</p>

<p>As part of a Drupal application in the health care industry I had to put some interesting rules around CRUD access to a content type, Prescription. Specifically the interesting requirements were</p>

<blockquote><p>Create a content type &lsquo;Prescription&rsquo;.
Give it a reference to an associated Nurse writing the Prescription.
Give it a reference to an associated Doctor, who can alter and approve the prescription.
Make the Prescription private to the client organization on the web application.
Within that organization, only let the Doctor and Nurse referenced by a Prescription view it.</p></blockquote>

<p>It was the last one that got me thinking. I started research, and found that Drupal 7 has hook_node_access_records() and hook_node_grants(). A little time with a debugger and watching changes to the node_access table opened up a clean, simple implementation of the requirements.</p>

<h1>How Access Grants Work</h1>

<p>Here is how things work. All access to a node in Drupal must pass permission checks according to the settings in the node_access table. So while you are developing, keeping an eye on this table is a wise idea.</p>

<p>When you do nothing, a row is created in that table that allows anyone to view that content type. But we aren&rsquo;t going to &ldquo;do nothing&rdquo; &mdash; we are going to make our own rules.</p>

<p>When you implement hook_node_access_records(), it will be called every time a node is saved. You have the opportunity to change what is going into the node_access table at this point. While you can read the details at <a href="https://api.drupal.org/api/drupal/modules%21node%21node.api.php/function/hook_node_access_records/7">hook_node_access_records</a>, here is a simple one that modifies the access grant for a Prescription content type.</p>

<pre><code>function mymodule_node_access_records($node) {
  $grants = array() ;

  if ($node-&gt;type == 'prescription') {
    $grants[] = array(
      'realm' = 'all',
      'gid' =&gt; 0,
      'grant_view' =&gt; 0,
      'grant_update' =&gt; 1,
      'grant_delete' =&gt; 0,
      'priority' =&gt; 1,
    );
   }
 return $grants;
}
</code></pre>

<p>The interesting points here are the &lsquo;realm&rsquo; and &lsquo;gid&rsquo; parameters. Together, with the $node->id field, comprise the key of the node access table. Combined, the realm and gid are a unique grant for the node. There values are abritrary, but the gid must be an integer.</p>

<p>So the above says if someone has the realm &lsquo;all&rsquo; and gid &lsquo;0&rsquo;, don&rsquo;t let them see the node in question, let them update it, and don&rsquo;t let them delete it.</p>

<p>Once grants are checked, if they pass, then the base node access system &mdash; the one you usually modify on the permissions tab &mdash; are checked. If <em>both</em> pass then the node is presented to the user.</p>

<p>Now you get pretty flexible here. In my situation I made some custom permissions, named the realms after them, and made two entries in the $grants array. In them I used, in turn, the user id of the Doctor and Nurse referenced by the Prescription. Now I had two rows in the node access table for the Prescription. One for the Doctor and one for the Nurse.</p>

<p>But how about the check when viewing the node?</p>

<h2>hook_node_grants</h2>

<p>This is the other side of the equation. When the user attempts to access the node for any CRUD operation, hook_node_grants is called in your module. Read the documentation here: <a href="://api.drupal.org/api/drupal/modules%21node%21node.api.php/function/hook_node_grants/7">hook_node_grants</a>.</p>

<p>Basically you are returning an array whose key is the realm from hook_node_access_records, and whose value is the gid. If a record in the node_access table matches the node id, the realm, and the gid, the access permissions for the operation in that row are used.</p>

<p>Let&rsquo;s say a user has the &lsquo;custom view prescription&rsquo; permission. You might write the hook like this</p>

<pre><code>function mymodule_node_grants($account, $op) {
  $grants = array();

  if (user_acces('custom view prescription', $account)) {
    $grants['custom view prescription'] = array($account-&gt;uid);
  }

  return $grants;
}
</code></pre>

<p>This code specifies to Drupal that, subject to the current permissions settings, the current user has the grant &lsquo;custom view prescription&rsquo;-uid. What that means was defined by a call to hook_node_access_records when the node was created.</p>

<h1>So What?</h1>

<p>When you take the time to think about it, I just very simply outlined a very small amount of code that implements a highly customized permissions system that, out of the box, Drupal does not support. Once I understood the interplay of the systems, this took about 2 hours to write and to write tests.</p>

<p>Grants, unlike custom access modules, even works with Views. This is a very flexible system that puts the ability to create all sorts of custom access patterns for your Drupal applications, meaning the complexity of the solutions you are able to provide just greatly increased.</p>

<p>Oh, and what about the standard access patterns? Well, after checking grants, Drupal still checks the regular access patterns. So if by some horrible mistake a doctor in one hospital is somehow associated with the prescription of another hospital, a smple separation of content into private organic groups denies the inappropriate access.</p>

<p>This was the result of a delightful Saturday afternoon with the Drupal documentation, a book on Safari Books Online, and a debugger. Some days just go nice.</p>

<p>Now back to running the engineering department. Annual reviews are due in a week &hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Emacs Dired Nodes]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/12/06/emacs-dired-nodes/"/>
    <updated>2012-12-06T07:09:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/12/06/emacs-dired-nodes</id>
    <content type="html"><![CDATA[<h1>Dired mode in Emacs.</h1>

<p>As part of my current attempt to revive old / acquire new Emacs skills, these are notes to myself on some of the neat things you can do with dired mode. This effort is motivated by the fact I now develop locally on OS-X, remotely on an Ubuntu VM, and plan to dual-boot the new Macbook Pro. Also, occasionally, I pair program with one of my guys on their VM or machine.</p>

<p>So I&rsquo;ve cleaning up my github account with my dotfiles so that I can more easily move my environment between machines and use the same tools, such as Emacs.</p>

<p>Emacs has too much beauty to grok fully while remembering to find time to breathe, so this is a subset of notes gathered from several sources.</p>

<table border="1" class="nrm" style="border:solid 1px #000000;border-collapse:collapse;margin:.5ex; width: 100%">
  <caption>Dired Commands</caption>
  <tr>
    <td align="center" valign="top" style="border:solid thin #808080; padding: .5ex; width: 20%;">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;M-x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;find-dired-mode&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;M-x&nbsp;hl-line-mode&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;highlights&nbsp;current&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<enter>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      go&nbsp;into&nbsp;a&nbsp;directory&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;leave&nbsp;a&nbsp;directory&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      change&nbsp;arguments&nbsp;to&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;inserts&nbsp;directory&nbsp;
      &nbsp;under&nbsp;cursor&nbsp;into&nbsp;&nbsp;current&nbsp;buffer.
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;deletes&nbsp;directory&nbsp;&nbsp;<br />
      from&nbsp;current&nbsp;buffer&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;touch&nbsp;current&nbsp;file&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;rename&nbsp;file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;symlink&nbsp;file&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Z&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;compress&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;uncompress&nbsp;file&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;mark&nbsp;for&nbsp;deletion&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;expunge&nbsp;file&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark&nbsp;file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;unmark&nbsp;file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;U&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;unmark&nbsp;all&nbsp;files&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-t&nbsp;C-t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      Incrementally&nbsp;search<br />
      &nbsp;through&nbsp;all&nbsp;files&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;g&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      mark&nbsp;files&nbsp;based&nbsp;on&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;regexp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      mark&nbsp;all&nbsp;directories
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;copy&nbsp;marked&nbsp;(or&nbsp;&nbsp;&nbsp;<br />
      &nbsp;current)&nbsp;items&nbsp;to&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kill&nbsp;ring&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="center" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-x&nbsp;C-q&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top"  style="border:solid thin #808080; padding: .5ex" >
      &nbsp;&nbsp;wdired.&nbsp;All&nbsp;file&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;names&nbsp;are&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;editable.&nbsp;Commit&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;with&nbsp;&#8216;C-c&nbsp;C-c&#8217;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>


<h2>Primary sources:</h2>

<ul>
<li><a href="http://emacsmovies.org/blog/2012/12/04/dired/">http://emacsmovies.org/blog/2012/12/04/dired/</a></li>
<li><a href="http://ergoemacs.org/emacs/file_management.html">http://ergoemacs.org/emacs/file_management.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Emacsclient Ignores Init File]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/11/14/emacsclient-ignores-init-file/"/>
    <updated>2012-11-14T21:47:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/11/14/emacsclient-ignores-init-file</id>
    <content type="html"><![CDATA[<p>Strangely</p>

<p><code></p>

<pre><code>emacsclient -t
</code></pre>

<p></code></p>

<p>does not seem to use my ~/.emacs.d/init.el file in the latest Emacs 24 when I start it as a daemon and open a frame. This is true on Ubuntu 12.?? and OSX.</p>

<p>This is really irritating, but since I really only need one frame 99% of the time I guess I&rsquo;ll ignore it. I did put an hour into playing with it and following Google Searches, but if anyone can tell me why this is so, I&rsquo;d love to know. I&rsquo;d like to have the daemon started when I boot my Macbook and my development VM, then have the client come up fast.</p>

<p>Interestingly if I load the init file in a buffer and evaluate the buffer, it all works fine.</p>

<p>Humpf.</p>

<p><strong>UPDATE:</strong> Of course this was simple late night, unclear thinking. All that was not working was keyboard-translate, which makes sense. Adding an alias to my environment worked around the issue and now all is well.</p>

<p><code></p>

<pre><code>alias emacs=emacsclient -t --eval '(keyboard-translate ?\C-t ?\C-x)'
</code></pre>

<p></code></p>

<p>Now my emacs setup runs in all my environments properly. Next: move the various dotfilies into a <em>dotfiles/</em> directory, toss it on github, and replicate that across environments. This will also neccessitate some thought as I commonly run tmux on my Macbook, ssh to my development server, then run tmux there. So the same .tmux-conf file with the same control key clearly won&rsquo;t work.</p>

<p>Maybe it&rsquo;s time to simply stop doing that and change my workflow. A problem to think about after a good nights sleep &hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Emacs Optimizations to Make]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/11/07/emacs-optimizations-to-make/"/>
    <updated>2012-11-07T07:44:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/11/07/emacs-optimizations-to-make</id>
    <content type="html"><![CDATA[<p>Notes to myself:</p>

<p>Optimize Emacs for ctags with current usage (PHP and JS mostly):</p>

<p><a href="http://www.koumbit.org/en/articles/using-exuberant-ctags-drupal">http://www.koumbit.org/en/articles/using-exuberant-ctags-drupal</a></p>

<p><a href="http://mwop.net/blog/134-exuberant-ctags-with-PHP-in-Vim.html">http://mwop.net/blog/134-exuberant-ctags-with-PHP-in-Vim.html</a></p>

<p><a href="http://weblogs.asp.net/george_v_reilly/archive/2009/03/24/exuberant-ctags-and-javascript.aspx">http://weblogs.asp.net/george_v_reilly/archive/2009/03/24/exuberant-ctags-and-javascript.aspx</a></p>

<p>Make Emacs work with terminal that works with Zsh and Tmux embedded (yes, that&rsquo;s right! Tmux in Emacs, not the other way around! It works for my workflow.):</p>

<p><a href="http://stackoverflow.com/questions/367442/getting-emacs-ansi-term-and-zsh-to-play-nicely">http://stackoverflow.com/questions/367442/getting-emacs-ansi-term-and-zsh-to-play-nicely</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA['Traveling November 2012']]></title>
    <link href="http://blog.johnstorey.org/blog/2012/11/02/traveling-november-2012/"/>
    <updated>2012-11-02T06:57:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/11/02/traveling-november-2012</id>
    <content type="html"><![CDATA[<p>For November I am telecommuting from Paris (though back in the U.S. a short time the first week of November.)</p>

<p>For updates, check out the online travel blog at</p>

<p><a href="http://www.offexploring.com/john-and-wini-paris-2012">http://www.offexploring.com/john-and-wini-paris-2012</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA['Tradeoffs Pre-paying a Mortgage']]></title>
    <link href="http://blog.johnstorey.org/blog/2012/10/18/tradeoffs-pre-paying-a-mortgage/"/>
    <updated>2012-10-18T13:49:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/10/18/tradeoffs-pre-paying-a-mortgage</id>
    <content type="html"><![CDATA[<p>These are some musings I have been having on the relative benefits of pre-paying your mortgage.</p>

<p>You see, I am in the process of buying a nice little loft conversion. Naturally the girlfriend is &mdash; before we are even funded &mdash; trying to figure out how quickly we can pre-pay the mortgage. Bless her financially conservative heart.</p>

<p>My first, unthinking reaction was to recoil in horror at the idea. &ldquo;We are getting under a 4% rate on this! Do you really think the Fed will keep inflation under 4% for the whole time we live here? Once they slip and it rises a little, we&rsquo;ll be effectively paying 0% on the loan. I NEVER want to pay an extra penny here!&rdquo;</p>

<p>Silly me. I actually do know better.</p>

<p>For those who are unaware, mortgages are not like an IOU with an interest rate. They are <em>amortized</em>. You can look up the details on Wikipedia, but for our purposes realize that 90%+ of your payments in the early years are the interest for the entire 30 years. Almost none of those payments reduce the principle of the loan.</p>

<p>Also realize I live in California, a no pre-payment penalty state. Lastly realize that if you pay more than your monthly payment and mark it as &ldquo;pay to principal&rdquo; you not only pay your principle down, but you cause them to re-amortize the loan. In essence, you drastically reduce the total amount of interest your are paying. Playing around with the calculator at <a href="http://www.bankrate.com/calculators/mortgages/mortgage-loan-payoff-calculator.aspx">pre-payment calculator</a> I see the following at an extra $3,000 a month to principal:</p>

<ul>
<li>$3,000 extra a month seems to be the point of diminishing returns.</li>
<li>My interest drops from about $150K to $50K over the life of the loan.</li>
<li>The loan is paid off in about 7 years rather than 30.</li>
</ul>


<p>Assuming it is possible to consistently pay an extra $3,000 a month I should do it right? I mean, I am avoiding $100K of $150K interest that way, which is a great return.</p>

<p>Well &hellip; there is this thing called the mortgage interest tax deduction. Both Obama and Romney are talking about getting rid of it despite who is elected next year, but I have my doubts. So now you have to add that in as well.</p>

<p>That&rsquo;s before considering things like the size of the emergency fund, expected household budget adjustments associated with owning a home, and so on. The point is that it is very hard to determine how much principal to pre-pay on a mortgage, and if it makes sense to do so. So don&rsquo;t blindly choose a &lsquo;yes&rsquo; or &lsquo;no&rsquo;. Instead sit down and do some real analysis of your situation.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Polyslipups and House Hunting]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/10/08/polyslipups-and-house-hunting/"/>
    <updated>2012-10-08T09:48:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/10/08/polyslipups-and-house-hunting</id>
    <content type="html"><![CDATA[<p>Just a quick update in my journal here.</p>

<p>Friday night I decided to sleep through the night. This turned out to be a suprisingly bad idea. Rather than giving me an exceptionally good nights sleep I work irritable, and stayed that way through the day. Also, I did not stay awake on Saturday from an unusual amount of exhaustion. Luckily I seem to have gotten back on Everyman 3 Sunday and feel like I am on track again.</p>

<p>On top of that I did not realize how used I had already become to having the additional time. Much was not done and frustration ensued. The upshot: monophasic is not a sleeping pattern that maximizes my happiness.</p>

<p>Also on Friday, even though we weren&rsquo;t planning to be ready to buy a house until December, but an incredible loft conversion in the right place with all the right things came on the market. We made an offer, and I spent Saturady putting together the financial paperwork for the loan application. It is very unlikely that it will all work out and we are likely to proceed with the original plan to look in December / January, but it would be very nice to get this one.</p>

<p>Don&rsquo;t ask me if it will work out &mdash; I think our lack of preparation led to a weak offer. But maybe God thinks differently. I&rsquo;ve seen much stranger things happen.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA['Sleep Still Rules Me']]></title>
    <link href="http://blog.johnstorey.org/blog/2012/09/29/sleep-still-rules-me/"/>
    <updated>2012-09-29T16:55:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/09/29/sleep-still-rules-me</id>
    <content type="html"><![CDATA[<p>This is more a note to myself so I can reflect on it in the future.</p>

<p>I am now on day 6 of Everyman 3. I misset the alarm for my 11 AM nap and overslept by about an hour. So I figured &ldquo;hey, no worries, at least I can skip my 4 PM nap.&rdquo; At 4 I was in a local coffee shop watching an MIT Open CourseWare class. Suddenly a wave of weariness washed over me.</p>

<p>Apparently my body is getting used to sleeping at 4 PM for 20 minutes. This is great! So I went home and lay down. Without even realizing that I had fallen asleep I awoke 13 minutes later. I felt relaxed and very awake.</p>

<p>So what am I deducing? My body is adjusting to the Everyman 3 sleep schedule well. While I could have stayed awake it would have been very sub-optimal.</p>

<p>Things I did in the last 24 hours I would not have done on a regular sleep schedule:</p>

<ul>
<li>Evaluate ZSH and installed it on my Macbook Air.</li>
<li>Found an open source tiling window manager, Spectacle, and installed it on the Macbook Air as well.</li>
<li>Went through a calculus class with <a href="http://thegreatcourses.com">The Great Courses</a>.</li>
<li>Got about half way through the first MIT lecture I am taking.</li>
</ul>


<p>That&rsquo;s on top of my early Saturday morning bike ride, reading of Barron&rsquo;s, and catching up on the companies in my portfolio.</p>

<p>It&rsquo;s 5 PM now, and I plan to sleep only another 20 minutes in the next 10. What will I finish during that time?</p>

<p>I&rsquo;m loving this. Now to make some dinner, then get back to the MIT course. Eventually the my cute half(I refuse to say &lsquo;better half&rsquo; preferring equality) will wake up and we&rsquo;ll go to the movies to see Dredd. Yes, on top of everything else, I now have time to tend to the relationship again, and that&rsquo;s paying nice dividends as well.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[First Polyphasic Friday]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/09/29/first-polyphasic-friday/"/>
    <updated>2012-09-29T00:04:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/09/29/first-polyphasic-friday</id>
    <content type="html"><![CDATA[<p>Here it is midnight on my first weekend on Everyman 3. I lay down for 20 minutes at 10:30 PM, and now I&rsquo;m awake until 3 AM when I take a 3 hour sleep. That&rsquo;s the big sleep for the day, and the majority of the 4 hours a day rest.</p>

<p>So far it&rsquo;s good. I&rsquo;ve been allowing myself a cup of coffee when I first wake from a nap, but now I am wondering if it is interfering with my ability to take my naps. True, I am on day 4 and it is supposed to take a month to fully adapt, but I still feel I don&rsquo;t get to sleep fast enough on the 20 minute nap. In another week I&rsquo;ll have to see where I am &hellip;</p>

<p>My mental faculties are ok, but not the top of where they can be. I am not fully rested &mdash; but I am as rested as I was on a normal weeknights sleep. This is the first night to myself where I don&rsquo;t need to work with the offshore teams. I&rsquo;ve continued working on my long, backlogged TODO list. Today I fixed this blog and put it on GitHub. After 4 months I finally got the email at johnstorey.org working again. After I complete this post my plan is to evaluate ZSH as a Bash replacement. If I have time and motivation after that I will start going through the MIT Open Courseware classes for Scheme. I last programmed a Lisp language about 24 years ago (ouch! getting old, aren&rsquo;t I!). Scheme did not exist back then boys and girls. But these days I keep bumping into Clojure, which is Lisp based. My thought is to</p>

<ul>
<li>Learn Scheme.</li>
<li>Review the MIT Open Courseware algorithm classes that are in Scheme.</li>
<li>Work through a paper I found to write a Scheme compiler in Scheme.</li>
</ul>


<p>This will meet the goals I have of</p>

<ul>
<li>Getting back into a functional language.</li>
<li>Lay a foundation for Emacs scripting.</li>
<li>Refresh my algorithms knowledge &mdash; every developer needs to do this every few years.</li>
<li>Write a compiler, which strangely, I&rsquo;ve never done. In concept it seems simple. Read some text, follow rules to transform it, and end up with the final transform creating assembly or object code.</li>
</ul>


<p>Not sure how far I will get on the Scheme front tonight as I am feeling an urge to space out and watch Season 3 of Fringe on Amazon. But it would be good to start.</p>

<p>I am enjoying the extra free time. I event started a light exercise routine again. At 11 PM I was the only one in the fitness center on a Friday night. The security guard gave me strange looks as she walked by, but hey, I <em>am</em> living unusual hours right now. I&rsquo;ll monitor how the exercise interacts with my sleep schedule and overall rest.</p>

<p>Now, on to that ZSH evaluation &hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Blog Reboot]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/09/28/blog-reboot/"/>
    <updated>2012-09-28T10:30:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/09/28/blog-reboot</id>
    <content type="html"><![CDATA[<p>As you can see, after much time, my blog has been restarted and moved to GitHub. Of course it&rsquo;s probably the 3rd or 4th blog start in my life, and I have lost more information than I&rsquo;ve kept. But trying again. Here are the highlights.</p>

<h1>Still on Octopress</h1>

<p>I don&rsquo;t see myself leaving <a href="http://octopress.org">Octopress</a> as a solution any time soon. It&rsquo;s very OS agnostic and fits nicely into my workflow. I&rsquo;ve even installed a custom theme (that took about 2 minutes &mdash; I love todays world.)</p>

<h1>Moved to GitHub Pages</h1>

<p>Secondly, johnstorey.org continues to have issues. I believe I&rsquo;ll get the email working again but won&rsquo;t bother hosting the blog on S3 again. Since I was hosted there GitHub has apparently started a service where you can have one repository served up as webpages called GitHub Pages. You can use the built in support for them in Octopress by following the directions <a href="http://http://robdodson.me/blog/2012/04/30/custom-domain-with-octopress-and-github-pages/">here</a>.</p>

<p>Score!</p>

<p>There were some minor issues, such as my existing RVM / Ruby installation with Octopress did not work. But I installed Ruby 1.9.3 support under RVM, downlodade a clean Octopress repository, and was soon up and running. The main problem was that Xcode made me click &lsquo;Install Command line tools&rsquo; explicitly. Silly Apple &mdash; that should be the default!</p>

<p>So between polyphasic sleeping and the ease of use of GitHub Pages maybe you&rsquo;ll see more frequent posts here!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Trying Polyphasic Sleeping]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/09/27/trying-polyphasic-sleeping/"/>
    <updated>2012-09-27T20:10:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/09/27/trying-polyphasic-sleeping</id>
    <content type="html"><![CDATA[<p>It&rsquo;s been a long time since I&rsquo;ve posted. Why? Because my job takes up 100% of my time, and my girlfriend another 30%. Life has gone back to extreme craziness.</p>

<p>Finally I was speaking to a client about <em>The Four Hour Body</em>, which I have yet to read. He spoke about polyphasic sleeping, which rang a bell in my head from years ago &hellip;</p>

<p>People are functional on 2 hours sleep? Say what? It&rsquo;s true. That&rsquo;s called the &ldquo;Uberman&rdquo; in the polyphasic world, and it&rsquo;s the most hard core you can get. All you do is nap every 4 hours. No other sleep.</p>

<p>Ouch.</p>

<p>But for 7+ years the IT staffer <a href="http://www.puredoxyk.com/index.php/polyphasic-sleep-portal/">puredoxyk</a>  has lived the &ldquo;Everyman 3&rdquo; schedule. In this plan you sleep three hours a night and have 3 daily naps of 20 minutes, for a total of 4 hours of sleep in 24. Better, it is a schedule that allows you to interact with the rest of humanity. Now I have people I talk to daily 12 and 13 timezones away. So I&rsquo;m often talking to them in the middle of the night, then with clients the next day. If there was only a way to be functional while doing that I could really smooth things out in many projects. Plus I could blog more, work on the novel plot, learn Clojure, review Calculus (I&rsquo;m ashamed to say I&rsquo;ve forgotten most of it), and more &hellip;</p>

<p>I&rsquo;m truly insane. It&rsquo;s day 3 now. My body is starting to adapt &mdash; or so I think. I didn&rsquo;t really maintain a great sleep schedule before, so it&rsquo;s hard to say. But yesterday I started actually sleeping during the 20 minute naps. I believe I am dreaming, but as before, I don&rsquo;t seem to remember 99% of my dreams. Today I woke from my 20 minute nap relaxed and refreshed. That should be a sign that REM sleep has been experienced.</p>

<p>Also, in the last 3 days, I&rsquo;ve accomplished more than I usually do in a week.</p>

<p>We&rsquo;ll see how well this lasts. It is supposed to take a month to really get your body used to it. The extra time is super useful in today&rsquo;s world though. I feel like back in the 90s when I did Atkins. Everyone thought it would kill me somehow. Instead there was a decrease in my waist from 48&#8221; to 33&#8221;. Could polyphasic sleeping be a repeat?</p>

<p>Stay tuned. See if I last!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Investments on Sale - Again!]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/05/04/investments-on-sale-again/"/>
    <updated>2012-05-04T12:13:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/05/04/investments-on-sale-again</id>
    <content type="html"><![CDATA[<p>Lately I&rsquo;ve been turning my eye back to my investments, primarily in equities. Well, really, since doing my takes and updating the retirement plan.</p>

<p>I&rsquo;m here to say: the news is good for the bargain hunter.</p>

<p>Marc Faber popped up in the Wall Street Journal today with a viewpoint that I believe: the U.S. market can see another 20% decline.</p>

<p>Helping dollar destruction, Bernanke seems poised to do QE3, even if it may be under another name.</p>

<p>Europe is the U.S. 2009 (oh, did I make money in oil futures that year? I did!). Spain is undoubtedly being combed by bargain hunters, but there is likely enough for everyone. With companies that have nice exposure to emerging markets in Latin America.</p>

<p>France is likely to elect Holland to run the place. Can we say an end to austerity in the Euro zone, cheap money everywhere, and more currency destruction.</p>

<p>Yes, I&rsquo;m really thinking alot about commodities again.</p>

<p>Other trends: we are a few years away from Social Security and Medicare running out in the U.S. That is a mega event beyond compare, and to be honest, I&rsquo;m not ready to take advantage of it. Time to make a plan.</p>

<p>There are some relevant factoids that should make any investor step back and reflect. There is lots going on here and values should pop up left and right, if only we can dig them out.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WTF Apple ?!?]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/04/19/wtf-apple/"/>
    <updated>2012-04-19T10:10:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/04/19/wtf-apple</id>
    <content type="html"><![CDATA[<p>Apple! My confused little company that brings beauty to computing. A little heart to heart. You, me, and the internet.</p>

<p>What misbegotten security theatre meme makes you suddenly want 3 &mdash; 3! &mdash; questions answered before you let me download more apps to my iPad 3? Why, of all the questions, are they so strange that I can only answer one? Why not let me choose the questions AND the answers? Why not let me opt out? Why is it so hard to buy things using you as a channel?</p>

<p>Let me calm down.</p>

<p>Look, more factors of authentication is not the answer. You quickly get past the point where the irritation is greater than the benefits. I will now go and fill in random answers to your random questions. You have wasted my time to the benefit of neither of us, and really irritated me.</p>

<p>Is this what you wanted?</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Drupalizing a Web Project]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/04/11/drupalizing-a-web-project/"/>
    <updated>2012-04-11T08:45:00-07:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/04/11/drupalizing-a-web-project</id>
    <content type="html"><![CDATA[<p>These are notes from <a href="http://dev.nodeone.se/en/drupalizing-a-web-project">http://dev.nodeone.se/en/drupalizing-a-web-project</a> for myself. Yes, a blog post summarizing a blog post. Just think of this as a page in my notebook. Without the dead trees.</p>

<ol>
<li>Understand the problem domain, likely issues, and needed functionality.</li>
<li>Map out content types and entities.</li>
<li> Access control.</li>
<li> Reuse across site?</li>
<li> Inter-relationships?</li>
<li>User groups and their properties.</li>
<li> Roles.</li>
<li> Profiles.</li>
<li> Etc.</li>
<li>Consider views into the data.</li>
<li>Consider business rules that can be put in Rules module.</li>
<li>Look at what this process might have missed.</li>
<li>Non-IA</li>
<li> Performance and scalability.</li>
<li> Localization and internationalization.</li>
<li> Data migration.</li>
<li> Integration</li>
<li> Etc.</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Adventures in Drupal Services endpoints]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/02/14/adventures-in-drupal-services-endpoints/"/>
    <updated>2012-02-14T10:06:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/02/14/adventures-in-drupal-services-endpoints</id>
    <content type="html"><![CDATA[<p>Adventures with Drupal Services</p>

<p>If you are writing a web services interface on top of Drupal 7, you might be tempted to do something like use menu callbacks. The menu system in Drupal really is just a bunch of code that is called and spits back HTML for you. It&rsquo;s common to write your own menu code that takes and spits back whatever you want. Now that I think of it, this is probably how the Drupal Services module is written way down. There is certainly no immediately obvious reason not to do it that way.</p>

<p>These are some notes I found while getting a simple services module written. They, like my current knowledge, are incomplete. In many areas I have yet to fathom why they are like this. My concern is limited to the use of the REST Server in the Services 3 code.</p>

<h1>More than CRUD.</h1>

<p>All this section comes from reading the code in services/servers/rest_server/includes/RESTServer.inc., particularly the method <strong>resolveController()</strong>. This method is the source of the most common error when writing your own services &mdash; <strong>Cannot find controller</strong>. It is worth your time to read the code and get a sense of how it works.</p>

<p>Services has CRUD hardwired into it. It assumes the following CRUD methods:</p>

<ul>
<li>retrieve</li>
<li>create</li>
<li>update</li>
<li>delete</li>
</ul>


<p>Now this is clearly not enough to make a pretty, full featured REST API. So Services 3 allows you to add in two other types of API endpoints.</p>

<h2>Actions.</h2>

<p>According to the README for the REST server for services, actions</p>

<p><quote>
are performed directly on the resource type, not an individual resource.
</quote></p>

<p>An example is given of telling a search engine to reindex itself. This does not act on any particular piece of content, but rather works across all the content at one time.</p>

<p>For my purposes I wanted to use more descriptive names on my endpoints than, say, &lsquo;create&rsquo; so I only used actions. But I could have easily given an alias to the create endpoint in the code. In retrospect I should have gone that way but we&rsquo;ll look at code using actions for everything in this post.</p>

<h2>Targeted Actions.</h2>

<p>These are like actions, something that does not fit in the default CRUD API layout. The difference is that these work on an particular piece of content. For example, an endpoint might tell Drupal to append some content to an entity.</p>

<p>POST <a href="http://example.com/api/entity/123/append/run%20concluded">http://example.com/api/entity/123/append/run%20concluded</a></p>

<p>This hypothetical call would append the string &ldquo;run concluded&rdquo; to some field on the entity with etid 123.</p>

<p>I did not use targeted actions, so they won&rsquo;t be in the code in this post, but the idea is prett simple.</p>

<h2>Relations.</h2>

<p>Relations are a little different in that they retrieve content related to the content in question. For example, you might want an API to get a list of all files associated with a particular entity. You might want it to read like this</p>

<p>GET <a href="http://example.com/api/entity/243/filelist">http://example.com/api/entity/243/filelist</a></p>

<p>Pretty simple when you understand it. These terms are all used in the documentation, but how to create anything other than the basic CRUD endpoints in your custom code is not explained. We&rsquo;ll be showing you how to create custom actions (discerned from studying how the code works) here. Presumably relations are not all that different, but I will not swear to it.</p>

<h2>Why all the different types?</h2>

<p>I can only assume that there is some REST specification of which I am unaware. It seems fine to me to make them all &lsquo;actions&rsquo;, which is much like saying &lsquo;menu callbacks&rsquo;. The code for the REST server would be simplified, as would writing hooks for it. But Greg Dunlap has been doing Services for quite some time, and I have faith that he led a total rewrite of the framework for a reason. So for now I am concerning myself with what is, rather than why it is that way.</p>

<p>(brief pause as plane is landing and I need to shut off the laptop.)</p>

<h1>Some code &mdash; finally!</h1>

<p>At the end of the day, the best thing turns out to study the <strong>resolveController()</strong> method in <strong>RESTServer.inc</strong>, as explained above. Then look at the implementations of <strong>hook_services_resources()</strong> in the directory <strong>services/resources</strong>. They will show you how to declare actions.</p>

<p>With all this background, we can finally do the actual simple part: write the code.</p>

<h2>Hooks away!</h2>

<p>Some days I love Drupal&rsquo;s hook system. It makes coding so pleasurable. Other times I wonder about bootstrap costs. But that&rsquo;s another story.</p>

<p>First, let&rsquo;s declare a simple api with actions only and no CRUD. Here are some custom entry points for the &lsquo;drupalchat&rsquo; endpoint. Also notice that the &lsquo;messagecreate&rsquo; endpoint takes a &lsquo;struct&rsquo; type of parameter, which is populated by Services with payload data for a POST call. For the sake of simplicity we&rsquo;ll not comment on the standard access callback.</p>

<p><code>
/<em>*
 * Implements hook_services_resources().
 </em>/
function chat_rest_services_resources() {
  $resources[&lsquo;drupalchat&rsquo;] = array();
  $resources[&lsquo;drupalchat&rsquo;][&lsquo;actions&rsquo;] = array(</p>

<pre><code>'messagecreate' =&gt; array(
  'help' =&gt; 'Send a new chat message.',
  'callback' =&gt; '_chat_rest_send_msg',
  'access callback' =&gt; 'chat_rest_access',
  'access arguments' =&gt; array('create'),
  'access arguments append' =&gt; TRUE,
  'args' =&gt; array(
    array(
      'name' =&gt; 'data',
      'type' =&gt; 'struct',
      'description' =&gt; 'Recipient user id and message to send.',
      'source' =&gt; 'data',
      'optional' =&gt; FALSE,
    ),
  ),
),
'newmessages' =&gt; array(
  'help' =&gt; 'Get any new chat messages.',
  'callback' =&gt; '_chat_rest_retrieve',
  'access callback' =&gt; 'chat_rest_access',
  'access arguments' =&gt; array('new'),
  'access arguments append' =&gt; TRUE,
),
'updatebuddylist' =&gt; array(
  'help' =&gt; 'Get currently buddy list status.',
  'callback' =&gt; '_chat_rest_buddylist',
  'access callback' =&gt; 'chat_rest_access',
  'access arguments' =&gt; array('new'),
  'access arguments append' =&gt; TRUE,
),
</code></pre>

<p>  );</p>

<p>  return $resources;
}
</code></p>

<p>Lastly, define the endpoints to be shown in the Services configuration page.</p>

<p><code>
function chat_rest_default_services_endpoint() {
  $endpoint = new stdClass;
  $endpoint->disabled = FALSE; // endpoint disabled initially
  $endpoint->name = &lsquo;drupalchat&rsquo;;
  $endpoint->title = &lsquo;Drupalchat REST API&rsquo;;
  $endpoint->server = &lsquo;rest_server&rsquo;;
  $endpoint->path = &lsquo;js-api&rsquo;;
  $endpoint->authentication = array(</p>

<pre><code>'drupalchat' =&gt; array(
  'alias' =&gt; '',
  'actions' =&gt; array(
    'messagecreate' =&gt; array(
      'enabled' =&gt; 1,
    ),
    'newmessages' =&gt; array(
      'enabled' =&gt; 1,
    ),
    'updatebuddylist' =&gt; array(
      'enabled' =&gt; 1,
    ),
  ),
),
</code></pre>

<p>  );</p>

<p>  // TODO turn this debug to 0
  $endpoint->debug = 1;
  $endpoints[] = $endpoint;
  return $endpoints;
}
</code></p>

<p>That&rsquo;s it! Declaring a custom Services endpoint (or here, 3)  really is not that difficult once you understand how to do it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[new-post]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/02/14/new-post/"/>
    <updated>2012-02-14T10:05:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/02/14/new-post</id>
    <content type="html"><![CDATA[
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Deficencies with Vagrant]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/01/07/deficencies-with-vagrant/"/>
    <updated>2012-01-07T08:13:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/01/07/deficencies-with-vagrant</id>
    <content type="html"><![CDATA[<p>I love the Vagrant project. Someday, hopefully soon, I&rsquo;ll be able to switch my whole developer organization over to using it. Here&rsquo;s a note to myself about what needs to happen first. I&rsquo;m posting so I can refer back from time to time and see if it&rsquo;s something we can use now (don&rsquo;t look at me, I&rsquo;m hacking on (Drupal)[<a href="http://drupal.org/">http://drupal.org/</a>]).</p>

<h1>Cannot Run in Bridged Mode</h1>

<p>You know what? For some reason in Virtual Box XDebug can only talk to a host  debugger if it&rsquo;s running in bridged networking mode. Unfortunately that is not a current Vagrant feature. I have seen a patch to network.rb that does not seem to work for me. Also I heard there is a patch in branch on Debian that was recently submitted.</p>

<p>On a personal level, if anyone can help me get XDebug working on OSX Lion and talking to MacGDP back on the host, I&rsquo;d greatly appreciate it. For my own work.</p>

<h1>Cannot Run on Windows Well</h1>

<p>This is a problem with gems that use native DLLs. Why do I care? <em>I</em> don&rsquo;t. Windows can disappear off the surface of hard drives across the planet for my money. But much of my company is full of developers who don&rsquo;t and don&rsquo;t desire to learn to work with anything other than Windows. I&rsquo;m just not going to move them anytime soon.</p>

<p>Unfortunately here is a current reality</p>

<ul>
<li>On Windows, Vagrant does not work on Ruby.</li>
<li>It does work on JRuby.</li>
<li>JRuby does not allow gems that use native API components.</li>
<li>Chef requires native API components.</li>
</ul>


<h1>When These Issues Resolve</h1>

<p>I&rsquo;ll be able to move the organization to Vagrant. Until then I&rsquo;ll get some of the value by distributing virtual machines and letting people share their source code folders into it.</p>

<p>It&rsquo;s annoying though. Vagrant is a great piece of software.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mobile Drupal Made Easy]]></title>
    <link href="http://blog.johnstorey.org/blog/2012/01/01/mobile-drupal-cheap/"/>
    <updated>2012-01-01T14:58:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2012/01/01/mobile-drupal-cheap</id>
    <content type="html"><![CDATA[<p>January 1st, 2012. What a great year 2011 has been! A VP Engineering position where we turned the company around from self-immolation, and moving in with the girlfriend. No matter what else you can say, it&rsquo;s been exciting and one of the bigger growth experiences of my life. So how to top it in 2012? Hey, how to match it?</p>

<p>I have no idea. So instead I took my one week off at the end of the year (hey, turning that company around was a 7 day a week job!) to return to my favorite technology, Drupal. After some struggles with the Drupal 7 core code I can create entities and fields willy nilly. In real life it&rsquo;s almost always better to create them in the UI and export them with Features, but for really understanding what&rsquo;s happening you need to get as deep into the code as possible. So I did that, and used the knowledge to sketch out a new module idea with a friend. You should see the fruits of that around March. She&rsquo;s busy writing a book for Packt, and I have real life coming back in two days. That&rsquo;s going to slow us down.</p>

<p>Now, on to the topic of this post &hellip;</p>

<h1>Mobile Drupal Made Easy</h1>

<p>That company where they hired me in as VPE? After a year the first project has come along where Drupal seems the most appropriate answer (along with Apache Solr and possibly Node.js). We have the client kickoff the second week of January, then it&rsquo;s a pell mell rush for a three month delivery. Having had a months warning one of the first things we did was sketch out a preliminary architecture, then map out the areas where we had missing experience or an unclear idea how to proceed. One of those was in how to make mobile apps connected to Drupal in the most convienent way possible.</p>

<p>The short story was, for this client, make a standalone app makes little sense. Yes, we want to be in the app store, but we are going to use about zero percent of the native functionality. So despite a strong Sencha Touch skillset we want to try a new approach.</p>

<h1>Proposed: Responsive Web in a Phone Gap Wrapper</h1>

<p>We plan to create a responsive web design (we&rsquo;ve done some internal development tests with the Omega Theme to great success.) Then wrap it in PhoneGap or Sencha Touch wrapped in Phone Gap. That&rsquo;s the part we have not tried yet.</p>

<p>So I have a full day until real life work starts up. The emails already indicate the client pressure will be huge, and the new project starting up won&rsquo;t lessen anything. Let&rsquo;s see if you get a post showing PhoneGap wrapping XHTML and sized with a responsive web design. I have high hopes the approach will work fine because (a) it makes sense, and (b) it turns out there is a session on how to do the same thing being given at Drupalcon Denver in March.</p>

<p>Look for a post showing how to do this over the next few weeks.</p>

<p>Happy New Year!
John</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Node.js and mongoDB BOF]]></title>
    <link href="http://blog.johnstorey.org/blog/2011/12/09/node-dot-js-and-mongodb-bof/"/>
    <updated>2011-12-09T16:47:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2011/12/09/node-dot-js-and-mongodb-bof</id>
    <content type="html"><![CDATA[<p><em>These are unedited notes from the MongoSV 2011 Conference</em></p>

<p>mongoDB node.js driver has native and JS BSON libraries. Many forums recommend using the JS one. Moderator agrees. He may split the JS driver out to a completely separate repository and project.</p>

<p>Now it does cool things like getting the raw, unparsed BSON data. Good for HTML5 games for example, where the parsing is too slow.</p>

<p>Then native C++ driver is 2X slower serializing data, and 5X faster deserializer. Moderator blames it on his own limited C++ skills. In practice he does not see this as a limiting factor in most applications.</p>

<h1>GridFS</h1>

<p>Moderator experimenting with a feature like GridFS. Uses a collection of documents that have a chunk in them that is binary. Wants to make binary types in mongo much more efficent. Basically the moment it hits binary, like a video, it starts streaming it without much overhead.</p>

<h1>Mongoose</h1>

<p>If you want performance, don&rsquo;t use it. It&rsquo;s all about validating types; getters and setters; more expressive query builder; etc. It&rsquo;s alot slower.</p>

<p>In V8 try / catch and getter / setter are just not optimized. Also there are some crazy overloading of operator types.</p>

<h1>Safe Writes</h1>

<p>Off by default in JS and most mongoDB drivers. Considering making it on by default. Otherwise there is no way for you to know if your transactions work for example.</p>

<h1>SSL Support</h1>

<p>v2.2 they will add SSL support to the drivers. It&rsquo;s only waiting on US Export license approval.</p>

<h1>Multi CPU systems</h1>

<p>In Node.js you used to have to fire up a node process per CPU. Now it&rsquo;s in a configuration file.</p>

<h1>Advantage of V8</h1>

<p>Because you are on V8 you get to use the latest JS stuff all the time. object.create(), not this.prototype for example.</p>

<p>Buffer objects are created outside of V8 heap and stays until you release it. But is direct memory access speed. Increased JS driver speed by 5x.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MoPub Scaling]]></title>
    <link href="http://blog.johnstorey.org/blog/2011/12/09/mopub-scaling/"/>
    <updated>2011-12-09T16:47:00-08:00</updated>
    <id>http://blog.johnstorey.org/blog/2011/12/09/mopub-scaling</id>
    <content type="html"><![CDATA[<p><em>These are unedited notes from the MongoSV 2011 Conference</em></p>

<p>50ms to process each event.</p>

<ul>
<li>Started as 3 founders hoping to bring Angry Birds on to the platform. Their customers are app developers.</li>
<li>Needed to scale quickly as customers came on</li>
<li>0 time to spend time on ops</li>
<li>chose Google App Engine</li>
<li>Python (?Guido? works on this team)</li>
</ul>


<p>Business objects are siloed per user account. One to many relationships.</p>

<p>Collect stats for every ad serve and ad interaction.</p>

<p>On app engine have a simple stats model.</p>

<h1>Realtime stats in GAE</h1>

<ul>
<li>datastore

<ul>
<li>expensive writes</li>
<li>slow writes 1 / sec/ entity group</li>
<li>fast reads 3 ms</li>
</ul>
</li>
<li>memcache</li>
<li>TaskQueues</li>
</ul>


<p>Cannot do sums over objects in GAE or even native map / reduces</p>

<p>Solution: Buffer into memcache then periodically flush to the datastore by pushing them into a TaskQueue.</p>

<h1>GAE Shortcomings</h1>

<ul>
<li>Transient downtime for writes</li>
<li>Read before write</li>
<li>memcache is fleeting, leading to data loss</li>
<li>Objects have become too large for transactions</li>
<li>writing to datastore, even buffered is expensive</li>
<li> pay for datastore CPU and app CPU. Way too costly.</li>
</ul>


<h1>AWS + Mongo</h1>

<ul>
<li>We have control of each service and the machines on which they run</li>
<li>access to RAM!</li>
<li>fire and forget increments</li>
<li>our entire machinery for recording mulitple stats is a series of increment instructions sent to MongoDB (which handles all buffering and flushing.)</li>
</ul>


<h1>First Attempt: Data Model</h1>

<p>One document per published advertiser per month. Each document stores data for all days and hours in the month.</p>

<h2>Initial results</h2>

<ul>
<li>Pros

<ul>
<li>Scales with # business objects</li>
<li>Queries for highel level cross products</li>
<li>Queries for stats for a given date range result in only reading the # of months total documents in the range</li>
</ul>
</li>
<li>Cons</li>
<li> Lots of little documents</li>
<li> more</li>
</ul>


<h1>Solution: New Data Model</h1>

<p>Account for ??? in our data model.</p>

<p>Everything in the account stored with hash table.</p>

<p>Created IndexDocument to store the reverse indices to do the higher-level cross sections</p>

<h2>Results</h2>

<ul>
<li>2 machines handle all the writes</li>
<li>Mongo load is now miniscule</li>
<li>each update really 2 (StatsDocument and StatsIndex)</li>
<li>Each get is really 2 gets (same objects)</li>
<li>One document per account per day</li>
<li> # documents scale with # accounts</li>
<li> we do the simple aggregation in python</li>
<li> size of document scales with # business objects within account</li>
<li> more</li>
</ul>


<h1>Lessons Learned</h1>

<ul>
<li>Better to have fewer, larger documents if there is a logical hierarchy than many smaller documents arranged flatly</li>
<li>Log everything because you will make mistakes</li>
<li> This has saved us time and again</li>
<li>Buy more memory</li>
<li> It&rsquo;s cheap!</li>
<li> Solved our cache misses</li>
<li> Some problems cannot be solved just by throwing memory at the problem</li>
</ul>


<h1>Future Work</h1>

<p>Mobile User store</p>

<ul>
<li>will record every interaction of every user</li>
<li>ML: map / reduce jobs to glean data about our suers and segment them</li>
<li>per user targeting with minimum latency</li>
<li>relevancy => better user experience => app devs make more money</li>
</ul>

]]></content>
  </entry>
  
</feed>
